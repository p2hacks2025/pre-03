# lefthook.yml
# Git hooks設定

pre-commit:
  parallel: true
  commands:
    # mainブランチでのコミットを禁止
    protect-main:
      run: |
        if [ "$(git rev-parse --abbrev-ref HEAD)" = "main" ]; then
          echo "====================================="
          echo "ERROR: mainブランチへの直接コミットは禁止されています"
          echo "新しいブランチを作成してください:"
          echo "  git checkout -b feature/your-feature-name"
          echo "====================================="
          exit 1
        fi

    # staged filesのみbiomeチェック + 自動修正
    biome-check:
      glob: "*.{js,ts,jsx,tsx,json,jsonc,css}"
      run: pnpm biome check --write --staged --no-errors-on-unmatched {staged_files}
      stage_fixed: true

pre-push:
  commands:
    typecheck:
      run: pnpm typecheck

# git pull後にlockfileが更新されていればpnpm install
post-merge:
  commands:
    install-deps:
      run: |
        if git diff-tree -r --name-only ORIG_HEAD HEAD | grep -q "pnpm-lock.yaml"; then
          echo "pnpm-lock.yaml が更新されました。依存関係をインストールします..."
          pnpm install
        fi

# ブランチ切り替え時にlockfileが変更されていればpnpm install
post-checkout:
  commands:
    install-deps:
      run: |
        # $3 = 1 はブランチ切り替え、0 はファイルチェックアウト
        if [ "$3" = "1" ]; then
          if git diff --name-only "$1" "$2" | grep -q "pnpm-lock.yaml"; then
            echo "pnpm-lock.yaml が変更されています。依存関係をインストールします..."
            pnpm install
          fi
        fi
