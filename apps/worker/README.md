# Worker Guide (apps/worker)

## このファイルでわかること

- プロジェクトのディレクトリ構造と設計思想
- 新しいジョブやタスクを追加するときの基本的な流れ
- どこを触っていいか/悪いかの判断基準

## ディレクトリ構造

`jobs → tasks` の2層構造

```
src
├── cli.ts
├── daemon.ts
├── jobs
│   └── {job-name}.ts
├── tasks
│   └── {task-name}.ts
└── lib
    ├── context.ts
    ├── env.ts
    └── index.ts
```

- 🟢: よく触る想定
- 🟡: 特定の変更のときだけ
- 🚫: 基本的に触らなくてよい（困ったら相談）

| ファイル/ディレクトリ | 役割 | 触る頻度 |
|---------------------|------|---------|
| `jobs/` | ジョブ層（複数タスクのオーケストレーション） | 🟢 ジョブ追加 |
| `tasks/` | タスク層（単一処理の実装） | 🟢 タスク追加 |
| `daemon.ts` | スケジュール定義・cron 登録 | 🟡 スケジュール追加時 |
| `cli.ts` | CLI エントリーポイント | 🚫 稀 |
| `lib/context.ts` | WorkerContext 生成 | 🟡 依存追加時 |
| `lib/env.ts` | 環境変数パース | 🟡 環境変数追加時 |

## 共通package

| パッケージ | 役割 | 触る頻度 |
|-----------|------|---------|
| `@packages/db` | Drizzle ORM スキーマ・クライアント | 🟢 DB操作 |
| `@packages/env` | 環境変数の型定義・バリデーション | 🟡 環境変数追加時 |
| `@packages/logger` | ロギングユーティリティ | 🚫 稀 |

---

## 2つの実行モード

### 1. CLI モード（単発実行）

```bash
pnpm worker job <job-name>
```

特定のジョブを1回だけ実行。デバッグや手動実行に使用。

### 2. デーモンモード（スケジュール実行）

```bash
pnpm worker daemon
```

`daemon.ts` に定義されたスケジュールに従って、ジョブを定期実行。本番環境ではプロセスマネージャー（PM2, systemd など）で管理。

---

## 新規実装時の基本的な流れ

### ジョブの追加

1. `tasks/{task-name}.ts` に個別タスクを実装
2. `tasks/index.ts` でエクスポート
3. `jobs/{job-name}.ts` にジョブを実装（タスクを組み合わせ）
4. `jobs/index.ts` でジョブを登録
5. （必要なら）`daemon.ts` にスケジュールを追加

→ 詳細な実装例は [RECIPES.md](./RECIPES.md#ジョブの追加) を参照

### タスクのみ追加

シンプルな処理の場合は、ジョブを作らずタスクだけ追加することも可能。

1. `tasks/{task-name}.ts` にタスクを実装
2. `tasks/index.ts` でエクスポート
3. 既存ジョブ内でタスクを呼び出し

→ 詳細な実装例は [RECIPES.md](./RECIPES.md#タスクの追加) を参照
