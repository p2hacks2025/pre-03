# AIæŠ•ç¨¿ç”Ÿæˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

## æ¦‚è¦

AIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«æŠ•ç¨¿ã‚’è¡Œã†æ©Ÿèƒ½ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥è¨˜ã«åå¿œã™ã‚‹æŠ•ç¨¿ã¨ã€ç‹¬ç«‹ã—ãŸã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³æŠ•ç¨¿ã®2ç¨®é¡ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
flowchart TB
    subgraph ShortTerm[Short-Term Job: 5åˆ†ã”ã¨]
        recentPosts[ç›´è¿‘30åˆ†ã®<br/>ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿] --> GPT1[GPT-4.1-nano]
        GPT1 --> aiPosts1[AIæŠ•ç¨¿<br/>2ä»¶/ãƒ¦ãƒ¼ã‚¶ãƒ¼]
        standalone1[ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³] --> GPT2[GPT-4.1-nano]
        GPT2 --> aiPosts2[AIæŠ•ç¨¿ 1ä»¶]
    end

    subgraph LongTerm[Long-Term Job: æ¯æ—¥3æ™‚]
        historical[7æ—¥ä»¥ä¸Šå‰ã®<br/>éå»æ—¥è¨˜<br/>ãƒ©ãƒ³ãƒ€ãƒ 10ä»¶] --> GPT3[GPT-4.1-nano]
        GPT3 --> aiPosts3[AIæŠ•ç¨¿<br/>2ä»¶/æ—¥è¨˜]
        standalone2[ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³] --> GPT4[GPT-4.1-nano]
        GPT4 --> aiPosts4[AIæŠ•ç¨¿ 1ä»¶]
    end

    subgraph FrequencyControl[é »åº¦åˆ¶å¾¡]
        check{ç›´è¿‘1æ™‚é–“ã®<br/>æŠ•ç¨¿æ•°ãƒã‚§ãƒƒã‚¯}
        check -->|5ä»¶ä»¥ä¸Š| skip[ã‚¹ã‚­ãƒƒãƒ—]
        check -->|1ä»¶æœªæº€| force[å¼·åˆ¶å®Ÿè¡Œ]
        check -->|1-4ä»¶| lottery[10%ç¢ºç‡ã§å®Ÿè¡Œ]
    end

    aiPosts1 --> DB[(Database)]
    aiPosts2 --> DB
    aiPosts3 --> DB
    aiPosts4 --> DB
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- **GPT-4.1-nano**: è»½é‡ãƒ»é«˜é€Ÿã€çŸ­æ–‡ç”Ÿæˆã«æœ€é©åŒ–
- **é »åº¦åˆ¶å¾¡**: ä¸Šé™5ä»¶/hã€ä¸‹é™1ä»¶/hã§TLã®æŠ•ç¨¿é »åº¦ã‚’ç®¡ç†
- **2ç¨®é¡ã®ã‚¸ãƒ§ãƒ–**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åå¿œï¼ˆshort-termï¼‰ã¨éå»æ—¥è¨˜ã®æ˜ã‚Šèµ·ã“ã—ï¼ˆlong-termï¼‰

---

## LLMè¨­å®š

è¨­å®šã¯ `lib/llm-config.ts` ã§ä¸€å…ƒç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚

| ç”¨é€” | ãƒ¢ãƒ‡ãƒ« | æœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³ | å‚™è€ƒ |
|------|--------|-------------|------|
| AIæŠ•ç¨¿ç”Ÿæˆ | gpt-4.1-nano | 500 | JSONå½¢å¼ã§å‡ºåŠ› |

```typescript
export const LLM_CONFIG = {
  aiPost: {
    model: "gpt-4.1-nano",
    maxCompletionTokens: 500,
    responseFormat: { type: "json_object" } as const,
  },
} as const;
```

---

## ç”Ÿæˆè¨­å®š

`tasks/ai-post.ts` ã® `AI_POST_CONFIG` ã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚

| è¨­å®š | å€¤ | èª¬æ˜ |
|------|-----|------|
| POSTS_PER_USER | 2 | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ—¥è¨˜ã‚ãŸã‚Šã®ç”Ÿæˆæ•° |
| STANDALONE_POST_COUNT | 1 | ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³æŠ•ç¨¿æ•° |
| MAX_POST_LENGTH | 50 | æœ€å¤§æ–‡å­—æ•° |
| SHORT_TERM_POST_CHANCE | 0.1 | short-termå®Ÿè¡Œç¢ºç‡ï¼ˆ10%ï¼‰ |
| LONG_TERM_POST_CHANCE | 0.5 | long-termå®Ÿè¡Œç¢ºç‡ï¼ˆ50%ï¼‰ |

---

## ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ«ãƒ¼ãƒ«

### åŸºæœ¬æ–¹é‡

| é …ç›® | ãƒ«ãƒ¼ãƒ« |
|------|--------|
| æ–‡å­—æ•° | 50æ–‡å­—ä»¥å†… |
| çµµæ–‡å­— | ãªã— or ãŸã¾ã«ï¼ˆè‡ªç„¶ãªå ´åˆã®ã¿ï¼‰ |
| æ–‡ä½“ | ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã€äººé–“ã‚‰ã—ã |
| ãƒˆãƒ¼ãƒ³ | ä¼šè©±çš„ã€è‡ªç„¶ä½“ |

### è‰¯ã„ä¾‹

```
- "ä»Šæ—¥ã¯ãªã‚“ã‹ã„ã„æ—¥ã ãª"
- "ã‚³ãƒ¼ãƒ’ãƒ¼é£²ã¿ã™ããŸ"
- "æ•£æ­©ã—ã¦ããŸã€æ°—æŒã¡ã‚ˆã‹ã£ãŸ"
- "æ˜æ—¥ã‚‚é ‘å¼µã‚‹ã‹"
- "é›¨ã‚„ã‚“ã§ã»ã—ã„"
```

### æ‚ªã„ä¾‹

```
- "ä»Šæ—¥ã¯ç´ æ™´ã‚‰ã—ã„ä¸€æ—¥ã§ã—ãŸï¼âœ¨ğŸ‰" ï¼ˆçµµæ–‡å­—éå¤šã€ãƒ•ã‚©ãƒ¼ãƒãƒ«ã™ãï¼‰
- "æœ¬æ—¥ã®æ´»å‹•å ±å‘Šã§ã™ã€‚" ï¼ˆå …ã™ãã‚‹ï¼‰
```

---

## é »åº¦åˆ¶å¾¡

`jobs/ai-post-short-term.ts` ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| è¨­å®š | å€¤ | èª¬æ˜ |
|------|-----|------|
| FREQUENCY_CHECK_WINDOW_MINUTES | 60 | ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®æ™‚é–“çª“ |
| MAX_POSTS_PER_HOUR | 5 | ä¸Šé™ï¼ˆè¶…éã§ã‚¹ã‚­ãƒƒãƒ—ï¼‰ |
| MIN_POSTS_PER_HOUR | 1 | ä¸‹é™ï¼ˆæœªæº€ã§å¼·åˆ¶å®Ÿè¡Œï¼‰ |

### ãƒ­ã‚¸ãƒƒã‚¯

```mermaid
flowchart TD
    start[ã‚¸ãƒ§ãƒ–é–‹å§‹] --> count[ç›´è¿‘1æ™‚é–“ã®æŠ•ç¨¿æ•°å–å¾—]
    count --> checkMax{5ä»¶ä»¥ä¸Š?}
    checkMax -->|Yes| skip1[ã‚¹ã‚­ãƒƒãƒ—]
    checkMax -->|No| checkMin{1ä»¶æœªæº€?}
    checkMin -->|Yes| force[å¼·åˆ¶å®Ÿè¡Œ]
    checkMin -->|No| lottery{10%æŠ½é¸}
    lottery -->|å½“é¸| execute[å®Ÿè¡Œ]
    lottery -->|å¤–ã‚Œ| skip2[ã‚¹ã‚­ãƒƒãƒ—]
    force --> execute
    execute --> generate[æŠ•ç¨¿ç”Ÿæˆ]
```

### å‹•çš„èª¿æ•´

æ®‹ã‚Šæ ãŒ3ä»¶æœªæº€ã®å ´åˆã€æŠ•ç¨¿æ•°ã‚’å‹•çš„ã«èª¿æ•´:

```typescript
if (remaining < 3) {
  effectivePostCount = Math.floor(Math.random() * (remaining + 1));
}
```

---

## ã‚¸ãƒ§ãƒ–è©³ç´°

### ai-post-short-term

| é …ç›® | å€¤ |
|------|-----|
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | `*/5 * * * *`ï¼ˆ5åˆ†ã”ã¨ï¼‰ |
| å®Ÿè¡Œç¢ºç‡ | 10%ï¼ˆä¸‹é™æœªæº€æ™‚ã¯å¼·åˆ¶ï¼‰ |
| å¯¾è±¡ | ç›´è¿‘30åˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ |
| å…¬é–‹æ™‚åˆ» | 1ã€œ30åˆ†å¾Œã«ãƒ©ãƒ³ãƒ€ãƒ åˆ†æ•£ |
| ç”Ÿæˆæ•°ï¼ˆå®Ÿè¡Œæ™‚ï¼‰ | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ—¥è¨˜Ã—2 + ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³1 |

### ai-post-long-term

| é …ç›® | å€¤ |
|------|-----|
| ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | `0 3 * * *`ï¼ˆæ¯æ—¥åˆå‰3æ™‚ï¼‰ |
| å®Ÿè¡Œç¢ºç‡ | 50% |
| å¯¾è±¡ | 7æ—¥ä»¥ä¸Šå‰ã®éå»æ—¥è¨˜ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ 10ä»¶ |
| å…¬é–‹æ™‚åˆ» | 1ã€œ24æ™‚é–“å¾Œã«ãƒ©ãƒ³ãƒ€ãƒ åˆ†æ•£ |
| ç”Ÿæˆæ•°ï¼ˆå®Ÿè¡Œæ™‚ï¼‰ | æ—¥è¨˜10ä»¶Ã—2 + ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³1 = æœ€å¤§21ä»¶ |

---

## å‡¦ç†ãƒ•ãƒ­ãƒ¼

### ai-post-short-term

```mermaid
sequenceDiagram
    participant Job as ai-post-short-term
    participant DB as Database
    participant GPT as GPT-4.1-nano

    Job->>DB: ç›´è¿‘1æ™‚é–“ã®æŠ•ç¨¿æ•°å–å¾—ï¼ˆcountRecentAiPostsï¼‰
    alt 5ä»¶ä»¥ä¸Š
        Job-->>Job: ã‚¹ã‚­ãƒƒãƒ—
    else 1ä»¶æœªæº€
        Job-->>Job: å¼·åˆ¶å®Ÿè¡Œ
    else 1-4ä»¶
        Job-->>Job: 10%æŠ½é¸
    end

    Job->>DB: ç›´è¿‘30åˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿å–å¾—
    Job->>DB: ãƒ©ãƒ³ãƒ€ãƒ AIãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—

    loop å„ãƒ¦ãƒ¼ã‚¶ãƒ¼
        Job->>GPT: æ—¥è¨˜å†…å®¹ â†’ AIæŠ•ç¨¿ç”Ÿæˆ
        GPT-->>Job: JSON { posts: ["æŠ•ç¨¿1", "æŠ•ç¨¿2"] }
        Job->>DB: AIæŠ•ç¨¿ä¿å­˜ï¼ˆpublishedAt: 1-30åˆ†å¾Œï¼‰
    end

    Job->>GPT: ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³æŠ•ç¨¿ç”Ÿæˆ
    GPT-->>Job: JSON { posts: ["æŠ•ç¨¿"] }
    Job->>DB: AIæŠ•ç¨¿ä¿å­˜
```

### ai-post-long-term

```mermaid
sequenceDiagram
    participant Job as ai-post-long-term
    participant DB as Database
    participant GPT as GPT-4.1-nano

    Job-->>Job: 50%æŠ½é¸

    Job->>DB: 7æ—¥ä»¥ä¸Šå‰ã®æ—¥è¨˜ã‚’ãƒ©ãƒ³ãƒ€ãƒ 10ä»¶å–å¾—
    Job->>DB: ãƒ©ãƒ³ãƒ€ãƒ AIãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—

    loop å„æ—¥è¨˜
        Job->>GPT: æ—¥è¨˜å†…å®¹ â†’ AIæŠ•ç¨¿ç”Ÿæˆ
        GPT-->>Job: JSON { posts: ["æŠ•ç¨¿1", "æŠ•ç¨¿2"] }
        Job->>DB: AIæŠ•ç¨¿ä¿å­˜ï¼ˆpublishedAt: 1-24æ™‚é–“å¾Œï¼‰
    end

    Job->>GPT: ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³æŠ•ç¨¿ç”Ÿæˆ
    GPT-->>Job: JSON { posts: ["æŠ•ç¨¿"] }
    Job->>DB: AIæŠ•ç¨¿ä¿å­˜
```

---

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `lib/llm-config.ts` | LLMè¨­å®šã®ä¸€å…ƒç®¡ç† |
| `lib/prompt.ts` | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ç½®æ›ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ |
| `lib/infra/ai-post.ts` | AIæŠ•ç¨¿ã®DBæ“ä½œï¼ˆä½œæˆã€ã‚«ã‚¦ãƒ³ãƒˆï¼‰ |
| `assets/prompts/ai_post_generation.md` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æ—¥è¨˜ãƒ™ãƒ¼ã‚¹ã®ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ |
| `assets/prompts/ai_post_standalone.md` | ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ |
| `tasks/ai-post.ts` | AIæŠ•ç¨¿ç”Ÿæˆã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ |
| `jobs/ai-post-short-term.ts` | short-termã‚¸ãƒ§ãƒ–ï¼ˆé »åº¦åˆ¶å¾¡å«ã‚€ï¼‰ |
| `jobs/ai-post-long-term.ts` | long-termã‚¸ãƒ§ãƒ– |
